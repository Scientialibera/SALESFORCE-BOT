# Deployment Updates - Dynamic MCP Discovery

## Changes Made

### 1. **Dynamic MCP Discovery in Deployment Script**
   - **File**: `deploy/deploy-aca.ps1`
   - **Changes**:
     - Automatically discovers all MCP servers in the `mcps/` folder
     - Builds and deploys each MCP dynamically (no hard-coded server lists)
     - Auto-generates `MCP_ENDPOINTS` and `LIST_OF_MCPS` for the orchestrator
     - Supports adding new MCPs without modifying the deployment script

### 2. **Local Development Startup Scripts**
   - **File**: `deploy/start-local.ps1`
     - Automated script that starts all services in separate PowerShell windows
     - Dynamically discovers MCPs
     - Checks for port conflicts and offers to kill conflicting processes
     - Auto-configures orchestrator with MCP endpoints
   
   - **File**: `deploy/show-local-commands.ps1`
     - Displays manual commands for starting each service
     - Useful for debugging individual services

## How It Works

### Dynamic MCP Discovery Algorithm

1. **Scan `mcps/` folder** for subdirectories
2. **Filter** out special folders (`__pycache__`, `TEMPLATE`, hidden folders)
3. **Check** for `Dockerfile` (deployment) or `server.py` (local)
4. **Assign ports** starting from 8001 (sql=8001, graph=8002, interpreter=8003)
5. **Build** MCP metadata (name, port, image, dockerfile path)
6. **Generate** `MCP_ENDPOINTS` JSON and `LIST_OF_MCPS` CSV for orchestrator

### Port Assignment

| Service | Port | URL |
|---------|------|-----|
| Orchestrator | 8000 | http://localhost:8000 |
| SQL MCP | 8001 | http://localhost:8001/mcp |
| Graph MCP | 8002 | http://localhost:8002/mcp |
| Interpreter MCP | 8003 | http://localhost:8003/mcp |
| *Future MCPs* | 8004+ | Auto-assigned |

## Usage

### Local Testing (Automated - Recommended)

```powershell
# Start all services in separate windows
cd C:\Users\emili\Documents\AGENTIC_TOOL_USER\agentic_framework\deploy
.\start-local.ps1
```

Options:
- `-KillExisting` - Automatically kill processes using required ports
- `-SkipPythonCheck` - Skip Python version check

### Local Testing (Manual)

```powershell
# Show commands to copy/paste into separate terminals
cd C:\Users\emili\Documents\AGENTIC_TOOL_USER\agentic_framework\deploy
.\show-local-commands.ps1
```

Then copy/paste the displayed commands into 4 separate PowerShell terminals.

### Azure Deployment

```powershell
# Deploy to Azure Container Apps
cd C:\Users\emili\Documents\AGENTIC_TOOL_USER\agentic_framework\deploy
.\deploy.ps1
```

The deployment script will:
1. Discover all MCPs in `mcps/` folder
2. Build Docker images for each MCP
3. Push images to Azure Container Registry
4. Deploy each MCP to Azure Container Apps
5. Auto-configure orchestrator with MCP endpoints

## Adding a New MCP

To add a new MCP (e.g., "analytics"):

1. **Create folder**: `mcps/analytics/`
2. **Add files**:
   - `server.py` - MCP server implementation
   - `Dockerfile` - Container definition
   - `requirements.txt` - Python dependencies
   - `README.md` - Documentation
3. **Done!** - Deployment scripts will automatically discover and deploy it

No changes needed to:
- ❌ Deployment scripts
- ❌ Orchestrator configuration
- ❌ Environment variables (except MCP-specific ones)

## Testing

### Test Orchestrator Health

```powershell
# Unauthenticated health check
Invoke-RestMethod -Uri http://localhost:8000/healthz -Method Get
```

### Test MCP Endpoints

```powershell
# Test each MCP
Invoke-RestMethod -Uri http://localhost:8001/mcp -Method Get  # SQL
Invoke-RestMethod -Uri http://localhost:8002/mcp -Method Get  # Graph
Invoke-RestMethod -Uri http://localhost:8003/mcp -Method Get  # Interpreter
```

### Test Chat API

```powershell
# Simple chat test (requires auth in production)
$body = @{
    messages = @(
        @{
            role = "user"
            content = "Calculate 100 * 25"
        }
    )
    user_id = "test@example.com"
} | ConvertTo-Json

Invoke-RestMethod -Uri http://localhost:8000/chat -Method Post -Body $body -ContentType "application/json"
```

## Environment Variables

### Required for Orchestrator

- `MCP_ENDPOINTS` - JSON map of MCP names to URLs (auto-generated)
- `LIST_OF_MCPS` - Comma-separated list of MCP names (auto-generated)

Example (auto-generated by scripts):
```json
{
  "sql_mcp": "http://localhost:8001/mcp",
  "graph_mcp": "http://localhost:8002/mcp",
  "interpreter_mcp": "http://localhost:8003/mcp"
}
```

### MCP-Specific Variables

Each MCP may require additional environment variables:

**SQL MCP**:
- `FABRIC_SQL_ENDPOINT`
- `FABRIC_SQL_DATABASE`
- `FABRIC_WORKSPACE_ID`

**Graph MCP**:
- `AZURE_COSMOS_GREMLIN_ENDPOINT`
- `AZURE_COSMOS_GREMLIN_DATABASE`
- `AZURE_COSMOS_GREMLIN_GRAPH`
- `AZURE_COSMOS_GREMLIN_PORT`

**Interpreter MCP**:
- (Uses Assistants API, no additional vars needed)

## Troubleshooting

### Port Already in Use

```powershell
# Check what's using a port
Get-NetTCPConnection -LocalPort 8000

# Kill the process
Stop-Process -Id <PID> -Force

# Or kill all Python processes
Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force
```

### Service Won't Start

1. Check `.env` file exists and has required variables
2. Verify Python is installed and in PATH
3. Check logs in the PowerShell window for the service
4. Ensure Azure credentials are configured (`az login`)

### Deployment Script Errors

1. Verify Azure CLI is installed (`az --version`)
2. Check you're logged in (`az account show`)
3. Verify resource group exists
4. Check ACR permissions

## Files Modified

- `deploy/deploy-aca.ps1` - Made dynamic MCP discovery
- `deploy/start-local.ps1` - Created automated local startup
- `deploy/show-local-commands.ps1` - Created manual command display

## Benefits

✅ **No hard-coded server lists** - Add MCPs without modifying deployment code
✅ **Consistent port assignment** - Automatic, predictable port allocation  
✅ **Auto-configured orchestrator** - MCP endpoints generated automatically
✅ **Simplified onboarding** - New team members can add MCPs easily
✅ **Reduced errors** - Fewer places to update when adding/removing MCPs
✅ **Better maintainability** - Single source of truth (folder structure)
